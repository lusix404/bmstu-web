map "$request_method:$uri" $cache_bypass {
    "~^GET:/(mirror/)?api" 1;
    "~^GET:" 0;
    default 1;
}

map $request_method $api_upstream {
    default backend_write;
    GET backend_get;
    HEAD backend_get;
    OPTIONS backend_get;
}

upstream backend_get {
    server gateway-main:8080 weight=2;
    server gateway-ro1:8080 weight=1;
    server gateway-ro2:8080 weight=1;
}

upstream backend_write {
    server gateway-main:8080;
}

upstream backend_mirror {
    server gateway-ro2:8080;
}

upstream backend_grafana {
    server grafana:3000;
}

proxy_headers_hash_max_size 51200;
proxy_headers_hash_bucket_size 6400;

server {
    listen 80;
    server_name _;
    client_max_body_size 20m;

    add_header X-Cache-Status $upstream_cache_status always;

    location ~* ^/api/v[12]/ {
        proxy_pass http://$api_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header Connection "";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_cache app_cache;
        proxy_cache_bypass $cache_bypass;
        proxy_no_cache $cache_bypass;
    }

    location /mirror/ {
        proxy_pass http://backend_mirror;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-Prefix /mirror;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_cache app_cache;
        proxy_cache_bypass $cache_bypass;
        proxy_no_cache $cache_bypass;
    }

    location /monitoring/ {
        proxy_pass http://backend_grafana;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Prefix /monitoring;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_cache app_cache;
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }

    location / {
        proxy_pass http://backend_write;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_cache app_cache;
        proxy_cache_bypass $cache_bypass;
        proxy_no_cache $cache_bypass;
    }

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
}
