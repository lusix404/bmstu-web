upstream coffeeshops_api {
    server localhost:7081; 
}

upstream db_admin {
    server localhost:8080;
}

server {
    listen 80;
    server_name  localhost;
    root C:/nginx;
    

    # 3 страницу swagger с описанием API
    location /api/v1 {
        proxy_pass http://coffeeshops_api/api/v1;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    location /api/v1/swagger/v1/swagger.json {
        proxy_pass http://coffeeshops_api/swagger/v1/swagger.json;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    
    

     # 4. старый интерфейс
    location /legacy {
        proxy_pass http://coffeeshops_api/api/v2/UserGui/login;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

     # 5 Readme.m
    location /diagram/ {
    alias C:/my_github/diagram/;  
    
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff";
    
    try_files $uri =404;
    }
    location /documentation {
        alias C:/nginx/coffeeshops_web/README.html;
        default_type text/html;
        charset utf-8;
        add_header X-Content-Type-Options "nosniff";
    }
    
    # 6. / на отдачу статики 
    location = / {
        try_files /static/index.html =404;
    }

    location /static/ {
        alias C:/nginx/static/;
        try_files $uri $uri/ /static/index.html =404;
    }

    location /static/img/ {
        alias C:/my_github/diagram/images/interface/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        try_files $uri =404;
    }

    #7. /reserved/ на отдачу той же страницы, что и /
    location = /reserved {
        try_files /static/index.html =404;
    }
	
     # 8 проксирование в web-админку базы данных
    location /admin/ {
        proxy_pass http://db_admin/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
    
   # 9 страница статуса сервера
    location /status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;
        add_header Content-Type "text/plain; charset=utf-8";
        add_header X-Content-Type-Options "nosniff";
    }

   
    # 10 ссылки на страницы
    location /management {
        default_type text/html;
        charset utf-8;
        
        return 200 '<!DOCTYPE html>
        <html lang="ru">
        <head>
            <style>
                body { 
                    background: #EDE7F3;
                    color: #272728;
                }
                .container { 
                    max-width: 800px; 
                    margin: 0 auto; 
                    background: #EDE7F3; 
                    padding: 30px; 
                    border-radius: 8px;
                }
                h1 { 
                    text-align: center; 
                    margin-bottom: 30px;
                    color: #272728;
                }
                .link-item { 
                    padding: 8px 0;
                    border-bottom: 1px solid #CB83E1;
                }
                a { 
                    color: #272728; 
                    text-decoration: none; 
                    font-weight: bold;
                    font-size: 16px;
                }
                a:hover {
                    text-decoration: underline;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>Панель управления (WebLab#4)</h1>
                    <div class="link-item">
                        <a href="/"> Начальная страница</a>
                    </div>
                    <div class="link-item">
            <a href="/api/v1"> Страница Swagger с описанием API</a>
        </div>
                    <div class="link-item">
                        <a href="/documentation"> Readme.md (WebLab#1)</a>
                    </div>
                    <div class="link-item">
                        <a href="/admin"> Проксирование в web-админку базы данных (Adminer)</a>
                    </div>
                    <div class="link-item">
                        <a href="/status"> Страница статуса сервера</a>
                    </div>
                    <div class="link-item">
                        <a href="/legacy"> Legacy</a>
                    </div>
            </div>
        </body>
        </html>';
    }


    location / {
        proxy_pass http://coffeeshops_api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
}