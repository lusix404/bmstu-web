version: "3.9"

services:
  db:
    image: bitnami/postgresql:latest
    environment:
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=lucy2004
      - POSTGRESQL_DATABASE=web_course
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=replicator2025
    ports:
      - "55433:5432"
    networks:
      - app-network
    volumes:
      - postgres_data:/bitnami/postgresql
      - ./init-db:/docker-entrypoint-initdb.d:Z
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d web_course"]
      interval: 5s
      timeout: 3s
      retries: 10

  db-replica:
    image: bitnami/postgresql:latest
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_PRIMARY_HOST=db
      - POSTGRESQL_PRIMARY_PORT_NUMBER=5432
      - POSTGRESQL_PRIMARY_USER=postgres
      - POSTGRESQL_PRIMARY_PASSWORD=lucy2004
      - POSTGRESQL_MASTER_HOST=db
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_MASTER_USER=postgres
      - POSTGRESQL_MASTER_PASSWORD=lucy2004
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=replicator2025
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=lucy2004
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-network
    volumes:
      - postgres_replica_data:/bitnami/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d web_course -h db-replica"]
      interval: 5s
      timeout: 3s
      retries: 10

  data-main:
    build:
      context: .
      dockerfile: Dockerfile.data
    image: coffeeshops-data:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: data-main
      ReadOnlyMode: "false"
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=web_course;Username=postgres;Password=lucy2004;"
      ConnectionStrings__UserConnection: "Host=db;Port=5432;Database=web_course;Username=ordinary_user;Password=user2025"
      ConnectionStrings__ModerConnection: "Host=db;Port=5432;Database=web_course;Username=moderator;Password=moder2025"
      ConnectionStrings__AdminConnection: "Host=db;Port=5432;Database=web_course;Username=administrator;Password=admin2025"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-network
    labels:
      AppInstance: data-main
      Role: write
    volumes:
      - ./logs/data-main:/app/logs:Z

  data-ro1:
    image: coffeeshops-data:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: data-ro1
      ReadOnlyMode: "true"
      ConnectionStrings__DefaultConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
      ConnectionStrings__UserConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
      ConnectionStrings__ModerConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
      ConnectionStrings__AdminConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
    depends_on:
      db:
        condition: service_healthy
      db-replica:
        condition: service_healthy
    networks:
      - app-network
    labels:
      AppInstance: data-ro1
      Role: read
    volumes:
      - ./logs/data-ro1:/app/logs:Z

  data-ro2:
    image: coffeeshops-data:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: data-ro2
      ReadOnlyMode: "true"
      ConnectionStrings__DefaultConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
      ConnectionStrings__UserConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
      ConnectionStrings__ModerConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
      ConnectionStrings__AdminConnection: "Host=db-replica;Port=5432;Database=web_course;Username=guest;Password=guest2025"
    depends_on:
      db:
        condition: service_healthy
      db-replica:
        condition: service_healthy
    networks:
      - app-network
    labels:
      AppInstance: data-ro2
      Role: read
    volumes:
      - ./logs/data-ro2:/app/logs:Z

  core-main:
    build:
      context: .
      dockerfile: Dockerfile.core
    image: coffeeshops-core:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: core-main
      ReadOnlyMode: "false"
      DataService__BaseUrl: "http://data-main:8080"
      Jwt__Secret: "secret-2025-web-lab-very-long-key!!"
    depends_on:
      data-main:
        condition: service_started
    networks:
      - app-network
    labels:
      AppInstance: core-main
      Role: write
    volumes:
      - ./logs/core-main:/app/logs:Z

  core-ro1:
    image: coffeeshops-core:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: core-ro1
      ReadOnlyMode: "true"
      DataService__BaseUrl: "http://data-ro1:8080"
      Jwt__Secret: "secret-2025-web-lab-very-long-key!!"
    depends_on:
      data-ro1:
        condition: service_started
    networks:
      - app-network
    labels:
      AppInstance: core-ro1
      Role: read
    volumes:
      - ./logs/core-ro1:/app/logs:Z

  core-ro2:
    image: coffeeshops-core:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: core-ro2
      ReadOnlyMode: "true"
      DataService__BaseUrl: "http://data-ro2:8080"
      Jwt__Secret: "secret-2025-web-lab-very-long-key!!"
    depends_on:
      data-ro2:
        condition: service_started
    networks:
      - app-network
    labels:
      AppInstance: core-ro2
      Role: read
    volumes:
      - ./logs/core-ro2:/app/logs:Z

  gateway-main:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    image: coffeeshops-gateway:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: gateway-main
      ReadOnlyMode: "false"
      CoreService__BaseUrl: "http://core-main:8080"
      Jwt__Secret: "secret-2025-web-lab-very-long-key!!"
    depends_on:
      core-main:
        condition: service_started
    networks:
      - app-network
    labels:
      AppInstance: gateway-main
      Role: write
    volumes:
      - ./logs/gateway-main:/app/logs:Z
      - ./logs/gateway-main:/app/Logs:Z

  gateway-ro1:
    image: coffeeshops-gateway:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      InstanceName: gateway-ro1
      ReadOnlyMode: "true"
      CoreService__BaseUrl: "http://core-ro1:8080"
      Jwt__Secret: "secret-2025-web-lab-very-long-key!!"
    depends_on:
      core-ro1:
        condition: service_started
    networks:
      - app-network
    labels:
      AppInstance: gateway-ro1
      Role: read
    volumes:
      - ./logs/gateway-ro1:/app/logs:Z
      - ./logs/gateway-ro1:/app/Logs:Z

  gateway-ro2:
    image: coffeeshops-gateway:latest
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_PATHBASE: "/mirror"
      PathBase: "/mirror"
      InstanceName: gateway-ro2
      ReadOnlyMode: "true"
      CoreService__BaseUrl: "http://core-ro2:8080"
      Jwt__Secret: "secret-2025-web-lab-very-long-key!!"
    depends_on:
      core-ro2:
        condition: service_started
    networks:
      - app-network
    labels:
      AppInstance: gateway-ro2
      Role: read
    volumes:
      - ./logs/gateway-ro2:/app/logs:Z
      - ./logs/gateway-ro2:/app/Logs:Z

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: coffeeshops-nginx:latest
    depends_on:
      gateway-main:
        condition: service_started
      gateway-ro1:
        condition: service_started
      gateway-ro2:
        condition: service_started
      grafana:
        condition: service_started
    ports:
      - "7080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro,Z
      - ./nginx/conf.d:/etc/nginx/conf.d:ro,Z
      - ./logs/nginx:/var/log/nginx:Z
    networks:
      - app-network

  loki:
    image: grafana/loki:2.9.0
    command: [ "-config.file=/etc/loki/config.yaml" ]
    networks:
      - app-network
    volumes:
      - ./monitoring/loki-config.yml:/etc/loki/config.yaml:ro,Z
      - loki_data:/loki

  promtail:
    image: grafana/promtail:2.9.0
    command: -config.file=/etc/promtail/config.yml
    user: root
    privileged: true
    networks:
      - app-network
    volumes:
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml:ro,Z
      - /var/lib/docker/containers:/var/lib/docker/containers:ro,Z
      - ./logs:/var/log/app:ro,Z
      - /var/run/docker.sock:/var/run/docker.sock:ro

  grafana:
    image: grafana/grafana:10.4.3
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://localhost:7080/monitoring/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    depends_on:
      - loki
    ports:
      - "7090:3000"
    networks:
      - app-network
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro,Z

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  postgres_data:
  postgres_replica_data:
  loki_data:
  grafana_data:
